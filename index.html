<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hoja Oficial Â· QR Lineup</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1e3a8a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1e6d; --surface:#132a7a; --surface2:#0f256d; --line:rgba(255,255,255,.15);
  --text:#f8fafc; --muted:#cbd5e1; --accent:#facc15; --accent-dark:#eab308; --ok:#22c55e; --danger:#ef4444;
}
*{box-sizing:border-box} html,body{margin:0;padding:0}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:linear-gradient(180deg,#0b1e6d 0%, #0a1a5a 100%);color:var(--text);line-height:1.6}
.container{width:100%;max-width:560px;margin:0 auto;padding:0.75rem}
h2{margin:.2rem 0 .6rem}
.small{font-size:.9rem;color:var(--muted)}

/* Portada */
.site-header{background:linear-gradient(90deg,#0f1f73 0%, #1e3a8a 50%, #0f1f73 100%);border-bottom:1px solid var(--line);padding:1.25rem 0;text-align:center}
.site-header img{max-width:260px;width:80%;height:auto;display:block;margin:0 auto;filter:drop-shadow(0 6px 16px rgba(0,0,0,.35))}

/* Card */
.card{background:linear-gradient(180deg,var(--surface) 0%, var(--surface2) 100%);border:1px solid var(--line);border-radius:1rem;padding:1rem;margin:1rem 0;box-shadow:0 8px 20px rgba(0,0,0,.35)}
.card h2{font-size:1.05rem;margin-top:0}

/* Meta */
.meta-grid{display:grid;grid-template-columns:1fr;gap:.8rem}
.meta-grid input, .meta-grid select{padding:.9rem;border:1px solid var(--line);border-radius:.6rem;background:#0a1117;color:var(--text)}
.box{display:flex;gap:1rem;border:1px dashed var(--line);padding:.6rem .8rem;border-radius:.6rem;flex-wrap:wrap}
.badge{display:inline-block;padding:.2rem .5rem;border-radius:.5rem;background:#0a1117;border:1px solid var(--line);font-size:.85rem}

/* Posiciones */
.pos-grid{display:flex;flex-direction:column;gap:.8rem;margin:1rem 0}
.pos-row{display:grid;grid-template-columns:48px 1fr;gap:.6rem;align-items:center}
.pos-row input{
  text-align:center;font-size:1.35rem;padding:.6rem;border:2px solid var(--accent-dark);
  border-radius:.6rem;background:var(--accent);color:#1e3a8a;font-weight:800
}

/* Botones */
.row{display:flex;flex-direction:column;gap:.6rem;margin-top:.6rem}
.btn{border:none;background:linear-gradient(180deg,#101826,#0b1320);color:var(--text);padding:1rem;border-radius:.9rem;cursor:pointer;width:100%;box-shadow:0 6px 14px rgba(0,0,0,.35);transition:transform .06s ease, box-shadow .2s ease}
.btn:hover{transform:translateY(-1px); box-shadow:0 10px 20px rgba(0,0,0,.4)}
.btn-primary{background:linear-gradient(90deg,var(--accent),#ffd84d); color:#1b1b00; font-weight:800}
.btn-ok{background:linear-gradient(180deg,#11361f,#0b2416)}
.btn-danger{background:linear-gradient(180deg,#2a0f14,#1b0a0d)}

/* QR y toast */
#qr{width:var(--qrsize,300px);min-height:var(--qrsize,300px);background:#0a1117;border:1px dashed var(--line);display:grid;place-items:center;border-radius:.8rem;margin:0 auto;padding:.6rem}
.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#0b2416;border:1px solid rgba(34,197,94,.35);color:#d1fae5;padding:.7rem 1rem;border-radius:.7rem;box-shadow:0 8px 18px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .25s ease}
.toast.show{opacity:1}

/* Scanner */
.scan-box{border:1px dashed var(--line);border-radius:.8rem;padding:.6rem;background:#0a1117}
.scan-row{display:flex;gap:.5rem;flex-wrap:wrap;margin:.6rem 0}
.scan-result{background:#0e1620;border:1px solid var(--line);border-radius:.6rem;padding:.6rem;margin-top:.6rem;font-family:ui-monospace, SFMono-Regular, Menlo, monospace}

/* Footer */
.site-footer{padding:1rem 0;border-top:1px solid var(--line)}
.footer-grid{display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:.85rem}
</style>

<!-- QR libs (con respaldo) -->
<script id="qrcode-cdn-1" src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" defer></script>
<script>
window.addEventListener('load', function(){
  setTimeout(function(){
    if(!window.QRCode){
      var s=document.createElement('script'); s.src='https://unpkg.com/qrcode/build/qrcode.min.js'; s.defer=true; document.head.appendChild(s);
    }
  },150);
});
</script>

<!-- jsPDF para PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>

<!-- Lector QR -->
<script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
<header class="site-header">
  <img src="dani.png" alt="Portada">
</header>

<main class="container">
  <!-- Meta -->
  <section class="card">
    <h2>Datos del set</h2>
    <form id="meta" class="meta-grid" onsubmit="return false;">
      <label>CÃ³digo equipo
        <input type="text" id="equipo" placeholder="CANGAS" required>
      </label>

      <fieldset class="box">
        <legend>Lado</legend>
        <label><input type="radio" name="side" value="A" checked> A</label>
        <label><input type="radio" name="side" value="B"> B</label>
      </fieldset>

      <label>Set
        <select id="set">
          <option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        </select>
      </label>

      <fieldset class="box">
        <legend>PosesiÃ³n inicial</legend>
        <label><input type="radio" name="serve" value="S" checked> Con saque</label>
        <label><input type="radio" name="serve" value="R"> Sin saque</label>
        <span class="badge">Se guarda por set Â· lado Â· posesiÃ³n</span>
      </fieldset>
    </form>

    <div class="row">
      <button id="btn-save" class="btn btn-ok">Guardar en este set</button>
      <button id="btn-copy-prev" class="btn">Copiar del set anterior</button>
      <button id="btn-save-next" class="btn">Guardar como siguiente set</button>
      <button id="btn-reset" class="btn btn-danger">Borrar todo</button>
    </div>
  </section>

  <!-- Posiciones -->
  <section class="card">
    <h2>Posiciones I â€“ VI</h2>
    <p class="small">Introduce dorsales (solo nÃºmeros). (+) rota ZN1â†’ZN6. Activa el bloqueo para evitar toques.</p>
    <div class="pos-grid">
      <div class="pos-row"><div class="lbl">I</div><input id="p1" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="3"></div>
      <div class="pos-row"><div class="lbl">II</div><input id="p2" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="3"></div>
      <div class="pos-row"><div class="lbl">III</div><input id="p3" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="3"></div>
      <div class="pos-row"><div class="lbl">IV</div><input id="p4" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="3"></div>
      <div class="pos-row"><div class="lbl">V</div><input id="p5" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="3"></div>
      <div class="pos-row"><div class="lbl">VI</div><input id="p6" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="3"></div>
    </div>
    <div class="row">
      <button id="rot-mas" class="btn">Rotar (+)</button>
      <button id="rot-menos" class="btn">Rotar (â€“)</button>
      <button id="btn-lock" class="btn">ðŸ”’ Bloquear / Desbloquear</button>
      <button id="btn-generar" class="btn btn-primary">Generar QR</button>
    </div>
  </section>

  <!-- QR -->
  <section class="card">
    <h2>QR</h2>
    <div class="small">TamaÃ±o:
      <select id="qr-size">
        <option value="240">PequeÃ±o</option>
        <option value="300" selected>Mediano</option>
        <option value="360">Grande</option>
      </select>
    </div>
    <div id="qr"></div>
    <div class="row">
      <button id="btn-png" class="btn btn-ok">Descargar PNG</button>
      <button id="btn-pdf" class="btn">Descargar PDF</button>
      <button id="btn-share" class="btn">Compartir</button>
    </div>
  </section>

  <!-- Escaneo inverso -->
  <section class="card">
    <h2>Escanear QR (comprobar hoja)</h2>
    <div class="scan-box">
      <div id="reader" style="width:100%;max-width:520px;"></div>
      <div class="scan-row">
        <button id="scan-start" class="btn">Iniciar cÃ¡mara (trasera)</button>
        <button id="scan-stop" class="btn">Detener cÃ¡mara</button>
      </div>
      <div class="scan-row">
        <select id="camera-list" class="btn" style="flex:1;appearance:none;text-align:left"></select>
        <button id="scan-switch" class="btn">Usar cÃ¡mara seleccionada</button>
        <button id="scan-torch" class="btn">Linterna ON/OFF</button>
      </div>
      <div id="scan-out" class="scan-result" style="display:none"></div>
    </div>
    <p class="small">Formato esperado: <code>["CODIGO","A|B","{\"ZN1\":\"..\",\"ZN2\":\"..\",\"ZN3\":\"..\",\"ZN4\":\"..\",\"ZN5\":\"..\",\"ZN6\":\"..\"}","SET"]</code></p>
  </section>

  <!-- Copias de seguridad -->
  <section class="card">
    <h2>Exportar / Importar rotaciones</h2>
    <div class="row">
      <button id="btn-export" class="btn">Exportar JSON</button>
      <label class="btn" style="display:inline-block;text-align:center;cursor:pointer">
        Importar JSON
        <input id="file-import" type="file" accept="application/json" style="display:none">
      </label>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-grid">
    <p>Â© <span id="year"></span> Hoja Oficial QR</p>
  </div>
</footer>

<div id="toast" class="toast">âœ… AcciÃ³n realizada</div>

<script>
/* ========= Utilidades / Estado ========= */
const $=s=>document.querySelector(s); const $$=s=>[...document.querySelectorAll(s)];
const yearEl=$('#year'); if(yearEl) yearEl.textContent=new Date().getFullYear();
const NS="hojaQR:v3";

/* Solo dÃ­gitos + debounce auto-guardado */
function onlyDigits(e){ e.target.value = e.target.value.replace(/\D+/g,'').slice(0,3); }
['#p1','#p2','#p3','#p4','#p5','#p6'].forEach(id=>{
  const el=$(id); el.addEventListener('input',onlyDigits); el.addEventListener('blur',onlyDigits);
});
let debounceT=null;
function debouncedAutoSave(){ clearTimeout(debounceT); debounceT=setTimeout(()=>{ safeAutoSave(); }, 300); }
['#p1','#p2','#p3','#p4','#p5','#p6','#equipo'].forEach(id=>{
  const el=$(id); el.addEventListener('input',debouncedAutoSave);
});
$$('input[name="side"],input[name="serve"]').forEach(el=> el.addEventListener('change',()=>{ loadCurrent() || null; }));

/* Helpers de lectura */
function getTeam(){ return ($('#equipo').value||'').trim().toUpperCase(); }
function getSide(){ return document.querySelector('input[name="side"]:checked').value; }
function getServe(){ return document.querySelector('input[name="serve"]:checked').value; } // S/R
function getSet(){ return $('#set').value; }
function key(set=getSet(), side=getSide(), serve=getServe()){ return `${NS}:${getTeam()||'--'}:set${set}:side${side}:pos${serve}`; }
function keyMeta(set=getSet(), side=getSide(), serve=getServe()){ return `${NS}:meta:${getTeam()||'--'}:set${set}:side${side}:pos${serve}`; }

function getPositions(){
  const v=[$('#p1').value,$('#p2').value,$('#p3').value,$('#p4').value,$('#p5').value,$('#p6').value].map(x=>x.trim());
  const set=new Set(v.filter(x=>x!==''));
  if(set.size!==v.filter(x=>x!=='').length) throw new Error('No puedes repetir dorsales.');
  if(v.some(x=>x==='')) throw new Error('Completa las 6 posiciones.');
  return v;
}
function setPositions(vals){[$('#p1'),$('#p2'),$('#p3'),$('#p4'),$('#p5'),$('#p6')].forEach((el,i)=>el.value=vals[i]??'');}

/* ========= Rotaciones / Bloqueo ========= */
let locked=false;
function rotatePlus(){ if(locked) return; const v=getPositions(); setPositions([v[1],v[2],v[3],v[4],v[5],v[0]]); }
function rotateMinus(){ if(locked) return; const v=getPositions(); setPositions([v[5],v[0],v[1],v[2],v[3],v[4]]); }
function toggleLock(){
  locked=!locked;
  ['#p1','#p2','#p3','#p4','#p5','#p6','#equipo','#set'].forEach(id=>{ const el=$(id); el.disabled=locked; });
  $$('input[name="side"],input[name="serve"]').forEach(el=> el.disabled=locked);
  toast(locked?'Bloqueado':'Desbloqueado');
}

/* ========= Guardado ========= */
function toast(msg){ const t=$('#toast'); t.textContent='âœ… '+msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); }
function saveCurrent(set=getSet(), side=getSide(), serve=getServe()){
  const equipo=getTeam(); if(!equipo){ toast('Pon el cÃ³digo de equipo'); return false; }
  let vals; try{ vals=getPositions(); }catch(e){ alert(e.message); return false; }
  const data={ v:vals, equipo, side, set, serve, ts:Date.now() };
  localStorage.setItem(key(set,side,serve), JSON.stringify(data));
  localStorage.setItem(keyMeta(set,side,serve), JSON.stringify({equipo, side}));
  toast(`Guardado set ${set} (${side}/${serve})`);
  return true;
}
function safeAutoSave(){ try{ if(getTeam()) saveCurrent(); }catch{} }
function loadCurrent(set=getSet(), side=getSide(), serve=getServe()){
  const raw=localStorage.getItem(key(set,side,serve));
  const meta=localStorage.getItem(keyMeta(set,side,serve));
  if(!raw) return false;
  try{
    const data=JSON.parse(raw);
    setPositions(data.v||['','','','','','']);
    if(meta){
      const m=JSON.parse(meta);
      $('#equipo').value=m.equipo||'';
      $$('input[name="side"]').forEach(r=> r.checked=(r.value===(m.side||'A')));
    }
    toast(`Cargado set ${set} (${side}/${serve})`);
    return true;
  }catch{ return false; }
}
function copyPrev(){
  const s=parseInt(getSet(),10); if(s<=1){ toast('No hay set anterior'); return; }
  const ok=loadCurrent(String(s-1), getSide(), getServe());
  if(ok){ saveCurrent(String(s), getSide(), getServe()); }
  else toast('No habÃ­a datos en el set anterior');
}
function saveNext(){
  const s=parseInt(getSet(),10); if(s>=5){ toast('No hay siguiente set'); return; }
  const ok=saveCurrent(String(s+1), getSide(), getServe());
  if(ok) toast(`Guardado como base del set ${s+1}`);
}

/* Reset */
function resetAll(){
  $('#equipo').value=''; $$('input[name="side"]').forEach(r=>r.checked=(r.value==='A'));
  $('#set').value='1'; $$('input[name="serve"]').forEach(r=>r.checked=(r.value==='S'));
  setPositions(['','','','','','']); $('#qr').innerHTML='';
  locked=false; toggleLock(); locked=false; // asegura desbloqueo visual
  toast('Campos borrados');
}

/* ========= Payload / QR ========= */
function buildPayload(){
  const equipo=getTeam(); if(!equipo) throw new Error('Introduce el cÃ³digo de equipo.');
  const side=getSide(); const set=getSet(); const v=getPositions();
  const zones={ZN1:v[0],ZN2:v[1],ZN3:v[2],ZN4:v[3],ZN5:v[4],ZN6:v[5]};
  // auto-guardar
  saveCurrent(set, side, getServe());
  return JSON.stringify([equipo,side,JSON.stringify(zones),set]);
}
function setQrSize(px){ document.documentElement.style.setProperty('--qrsize', px+'px'); }
$('#qr-size').addEventListener('change', e=>{ setQrSize(parseInt(e.target.value,10)); if($('#qr').firstChild){ generate(false); } });

function renderQR(text){
  const box=$('#qr'); box.innerHTML='';
  const size=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--qrsize')||'300',10);
  function drawWithLib(){
    const canvas=document.createElement('canvas');
    try{
      window.QRCode.toCanvas(canvas,text,{width:size,margin:1},e=>{
        if(e){ console.error(e); drawFallback(); }
      });
      box.appendChild(canvas);
    }catch(err){ drawFallback(); }
  }
  function drawFallback(){
    const img=document.createElement('img'); img.alt='QR'; img.width=size; img.height=size;
    img.src='https://api.qrserver.com/v1/create-qr-code/?size='+size+'x'+size+'&data='+encodeURIComponent(text);
    box.appendChild(img);
  }
  let tries=0; (function waitForLib(){ if(window.QRCode){ drawWithLib(); }
    else if(tries++<20){ setTimeout(waitForLib,100); } else { drawFallback(); }})();
}
function generate(showToast=true){ try{ renderQR(buildPayload()); if(showToast) toast('QR generado'); navigator.vibrate?.(15); }catch(e){ alert(e.message); } }

/* Long-press => generar + descargar */
let pressTimer=null;
$('#btn-generar').addEventListener('mousedown',()=>{ pressTimer=setTimeout(()=>{ generate(false); downloadPNG(); },600); });
['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>$('#btn-generar').addEventListener(ev,()=>clearTimeout(pressTimer)));

/* Descargar PNG / Compartir / PDF */
function canvasOrImage(){ return document.querySelector('#qr canvas') || document.querySelector('#qr img'); }
function downloadPNG(){
  const node=canvasOrImage(); if(!node){ alert('Genera el QR primero.'); return; }
  if(node.toDataURL){ const a=document.createElement('a'); a.href=node.toDataURL('image/png'); a.download='hoja-oficial-qr.png'; a.click(); }
  else { window.open(node.src,'_blank'); }
}
async function shareQR(){
  const node=canvasOrImage(); if(!node){ alert('Genera el QR primero.'); return; }
  try{
    let file;
    if(node.toDataURL){
      const dataUrl=node.toDataURL('image/png');
      const res=await fetch(dataUrl); const blob=await res.blob();
      file=new File([blob],'hoja-oficial-qr.png',{type:'image/png'});
    }else{
      const res=await fetch(node.src); const blob=await res.blob();
      file=new File([blob],'hoja-oficial-qr.png',{type:'image/png'});
    }
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({ title:'Hoja Oficial QR', text:`${getTeam()} Â· Set ${getSet()} Â· Lado ${getSide()}`, files:[file] });
    }else{
      downloadPNG();
    }
  }catch(err){ downloadPNG(); }
}
async function downloadPDF(){
  const node=canvasOrImage(); if(!node){ alert('Genera el QR primero.'); return; }
  const { jsPDF } = window.jspdf || window.jspdf || {};
  if(!jsPDF){ alert('jsPDF no cargÃ³ aÃºn. Prueba de nuevo.'); return; }
  const doc=new jsPDF({ unit:'pt', format:'a4' });
  // Encabezado con logo si existe
  try{
    const img=await fetch('dani.png'); const blob=await img.blob();
    const b64=await blobToDataURL(blob);
    doc.addImage(b64,'PNG',40,30,120,120);
  }catch{}
  // TÃ­tulo / datos
  doc.setFont('helvetica','bold'); doc.setFontSize(18);
  doc.text('Hoja Oficial Â· QR', 40, 180);
  doc.setFontSize(12); doc.setFont('helvetica','normal');
  doc.text(`Equipo: ${getTeam()}    Lado: ${getSide()}    Set: ${getSet()}`, 40, 205);

  // ZN1..ZN6
  const v=[ '#p1','#p2','#p3','#p4','#p5','#p6' ].map(id=>$(id).value);
  doc.text(`ZN1..ZN6: ${v.join(', ')}`, 40, 225);

  // QR
  let qrData;
  if(node.toDataURL){ qrData=node.toDataURL('image/png'); }
  else{ const res=await fetch(node.src); const blob=await res.blob(); qrData=await blobToDataURL(blob); }
  doc.addImage(qrData,'PNG', 40, 260, 260, 260);

  doc.save('hoja-oficial-qr.pdf');
}
function blobToDataURL(blob){ return new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(blob); }); }

/* ========= Scanner ========= */
let html5QrcodeObj=null, currentCamId=null, torchOn=false;
async function listCameras(){
  try{
    const cams=await Html5Qrcode.getCameras();
    const sel=$('#camera-list'); sel.innerHTML='';
    if(!cams?.length){ sel.innerHTML='<option value="">(Sin cÃ¡maras)</option>'; return; }
    cams.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.label||c.id; sel.appendChild(o); });
    // Selecciona trasera si se reconoce
    const back=cams.find(c=>/back|rear|environment/gi.test(c.label));
    sel.value=back? back.id : cams[0].id;
  }catch(e){ /* ignore */ }
}
async function startScan(camIdPref=null){
  if(!window.Html5Qrcode){ alert('Cargando cÃ¡maraâ€¦ intÃ©ntalo en 1â€“2 s.'); return; }
  if(html5QrcodeObj){ return; }
  await listCameras();
  html5QrcodeObj=new Html5Qrcode("reader");
  try{
    if(camIdPref){ currentCamId=camIdPref; }
    await html5QrcodeObj.start(
      currentCamId || { facingMode:"environment" },
      { fps:10, qrbox:{ width:250, height:250 } },
      onScanSuccess, ()=>{}
    );
  }catch(e){
    try{
      const cams=await Html5Qrcode.getCameras();
      currentCamId = cams && cams.length ? cams[0].id : null;
      if(!currentCamId){ alert('No se encontrÃ³ cÃ¡mara.'); html5QrcodeObj=null; return; }
      await html5QrcodeObj.start(currentCamId,{ fps:10, qrbox:{ width:250, height:250 } }, onScanSuccess, ()=>{});
    }catch(err){ alert('No se pudo iniciar la cÃ¡mara: '+err); html5QrcodeObj=null; }
  }
}
function stopScan(){
  if(html5QrcodeObj){
    html5QrcodeObj.stop().then(()=>{ html5QrcodeObj.clear(); html5QrcodeObj=null; currentCamId=null; })
      .catch(()=>{});
  }
}
async function switchCamera(){
  const id=$('#camera-list').value;
  if(!id){ return; }
  stopScan();
  setTimeout(()=> startScan(id), 200);
}
async function toggleTorch(){
  if(!html5QrcodeObj){ toast('Inicia la cÃ¡mara primero'); return; }
  try{
    torchOn=!torchOn;
    await html5QrcodeObj.applyVideoConstraints({ advanced:[{ torch: torchOn }]});
    toast(torchOn?'Linterna ON':'Linterna OFF');
  }catch(e){
    toast('Linterna no soportada en este dispositivo');
    torchOn=false;
  }
}
function onScanSuccess(decodedText){
  let out=$('#scan-out'); out.style.display='block';
  try{
    const arr=JSON.parse(decodedText);
    const equipo=arr[0], side=arr[1], set=arr[3];
    const zones=JSON.parse(arr[2]);
    out.innerHTML = `<strong>Equipo:</strong> ${equipo}<br><strong>Lado:</strong> ${side}<br><strong>Set:</strong> ${set}<br><strong>ZN1..ZN6:</strong> ${zones.ZN1}, ${zones.ZN2}, ${zones.ZN3}, ${zones.ZN4}, ${zones.ZN5}, ${zones.ZN6}`;
    navigator.vibrate?.(10);
  }catch(e){ out.textContent='Formato no reconocido: '+decodedText; }
}

/* ========= Exportar / Importar ========= */
function exportJSON(){
  const all={};
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k && k.startsWith(NS)) all[k]=localStorage.getItem(k);
  }
  const blob=new Blob([JSON.stringify(all,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rotaciones-hojaqr.json'; a.click();
}
function importJSON(file){
  const fr=new FileReader();
  fr.onload=()=>{
    try{
      const obj=JSON.parse(fr.result);
      Object.entries(obj).forEach(([k,v])=>{
        if(k.startsWith(NS)) localStorage.setItem(k,v);
      });
      toast('Importado correctamente');
      listCameras(); // no sobra, refresca UI si hubiese algo
    }catch{ alert('Archivo invÃ¡lido'); }
  };
  fr.readAsText(file);
}

/* ========= Eventos ========= */
$('#rot-mas').addEventListener('click',e=>{e.preventDefault(); try{rotatePlus();}catch(err){alert(err.message);}});
$('#rot-menos').addEventListener('click',e=>{e.preventDefault(); try{rotateMinus();}catch(err){alert(err.message);}});
$('#btn-lock').addEventListener('click',e=>{e.preventDefault(); toggleLock();});
$('#btn-generar').addEventListener('click',e=>{e.preventDefault(); generate();});
$('#btn-png').addEventListener('click',e=>{e.preventDefault(); downloadPNG();});
$('#btn-share').addEventListener('click',e=>{e.preventDefault(); shareQR();});
$('#btn-pdf').addEventListener('click',e=>{e.preventDefault(); downloadPDF();});
$('#btn-reset').addEventListener('click',e=>{e.preventDefault(); resetAll();});
$('#btn-save').addEventListener('click',e=>{e.preventDefault(); saveCurrent();});
$('#btn-copy-prev').addEventListener('click',e=>{e.preventDefault(); copyPrev();});
$('#btn-save-next').addEventListener('click',e=>{e.preventDefault(); saveNext();});
$('#scan-start').addEventListener('click',e=>{e.preventDefault(); startScan();});
$('#scan-stop').addEventListener('click',e=>{e.preventDefault(); stopScan();});
$('#scan-switch').addEventListener('click',e=>{e.preventDefault(); switchCamera();});
$('#scan-torch').addEventListener('click',e=>{e.preventDefault(); toggleTorch();});
$('#camera-list').addEventListener('focus',()=> listCameras());
$('#set').addEventListener('change',()=>{ loadCurrent() || setPositions(['','','','','','']); });
$$('input[name="serve"]').forEach(r=> r.addEventListener('change',()=>{ loadCurrent() || null; }));

/* ========= PWA: registrar SW ========= */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('service-worker.js').catch(()=>{}));
}

/* ========= InicializaciÃ³n ========= */
setQrSize(parseInt($('#qr-size').value,10));
listCameras();
</script>
</body>
</html>
